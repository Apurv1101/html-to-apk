name: Build Cordova APK (Localhost WebView + Assets)

on:
  push:
    branches: [ main ]

jobs:
  build:
    name: Cordova Android Build
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v3

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: ğŸ“¦ Install Cordova & Android SDK Tools
      run: |
        npm install -g cordova

    - name: ğŸ“ Create Cordova Project & Add Plugins
      run: |
        cordova create cordovaapp com.example.localwebapp LocalWebApp
        cd cordovaapp
        cordova platform add android@12
        cordova plugin add cordova-plugin-camera
        cordova plugin add cordova-plugin-media-capture
        cordova plugin add cordova-plugin-media
        cordova plugin add cordova-plugin-android-permissions
        cordova plugin add cordova-plugin-whitelist

    - name: ğŸ“‚ Copy HTML + Assets to www/
      run: |
        cp app.html cordovaapp/www/index.html
        cp logo.jpg cordovaapp/www/logo.jpg || true
        cp thankyou.mp3 cordovaapp/www/thankyou.mp3 || true

    - name: ğŸ“ Write config.xml
      run: |
        cat <<EOF > cordovaapp/config.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <widget id="com.example.localwebapp" version="1.0.0"
            xmlns="http://www.w3.org/ns/widgets"
            xmlns:cdv="http://cordova.apache.org/ns/1.0"
            xmlns:android="http://schemas.android.com/apk/res/android">
          <name>LocalWebApp</name>
          <content src="http://127.0.0.1:5000/" />
          <access origin="*" />
          <allow-navigation href="http://127.0.0.1:*" />
          <preference name="AndroidInsecureFileModeEnabled" value="true" />
          <platform name="android">
            <edit-config file="AndroidManifest.xml" mode="merge" target="/manifest/uses-permission">
              <uses-permission android:name="android.permission.CAMERA" />
              <uses-permission android:name="android.permission.INTERNET" />
            </edit-config>
          </platform>
          <plugin name="cordova-plugin-whitelist" />
        </widget>
        EOF

    - name: ğŸ§ª Check Cordova Requirements (Debug)
      run: |
        cd cordovaapp
        cordova requirements || true

    - name: ğŸ› ï¸ Build APK (with full logs)
      run: |
        cd cordovaapp
        cordova build android --verbose || true

    - name: ğŸ” Debug APK Output Location
      run: |
        echo "Searching for all APKs..."
        find cordovaapp -name "*.apk" || echo "âŒ No APK generated"

    - name: ğŸ“¤ Upload APK (if exists)
      uses: actions/upload-artifact@v4
      with:
        name: localwebview-apk
        path: cordovaapp/platforms/android/app/build/outputs/apk/debug/app-debug.apk
